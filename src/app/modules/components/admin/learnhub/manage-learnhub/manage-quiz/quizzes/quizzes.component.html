<div class="app-container">
  <div class="section-title">
    <h1 *ngIf="isEditMode">Administrimi - Modifiko Kuizin</h1>
    <h1 *ngIf="!isEditMode">Administrimi - Shto Kuiz të Ri</h1>
    <p>
      {{ isEditMode ? 'Në këtë seksion mund të modifikoni kuizin ekzistues. Sigurohuni që informacioni të jetë i saktë përpara se të ruani ndryshimet.' : 'Në këtë seksion mund të shtoni një kuiz të ri. Plotësoni të gjitha fushat e kërkuara për të krijuar një kuiz të ri në sistem.' }}
    </p>
  </div>
  <div class="action-button-row">
    <button mat-raised-button (click)="goBack()" matTooltip="Kthehu Mbrapa" matTooltipPosition="above"
            class="back-button" color="warn">
      <mat-icon>arrow_back</mat-icon>
      Kthehu te lista
    </button>
  </div>

  <div class="quiz-form-container">
    <div class="modal-header">
      <h3>{{ isEditMode ? 'Ndrysho Pyetjen e Kuizit' : 'Shto Pyetje të Re Kuizi' }}</h3>
    </div>
    <div class="quiz-form-content">
      <form [formGroup]="quizFormGroup">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>LLoj i Kuicit</mat-label>
          <mat-select formControlName="quizType" required>
            <mat-option *ngFor="let type of quizTypes" [value]="type.id">
              {{ type.name }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="quizFormGroup.get('quizType')?.hasError('required')">
            Fushë e detyrueshme
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Teksti i Pyetjes</mat-label>
          <textarea matInput formControlName="question" rows="3" required></textarea>
          <mat-error *ngIf="quizFormGroup.get('question')?.hasError('required')">
            Teksti i pyetjes është i detyrueshëm.
          </mat-error>
        </mat-form-field>

        <!-- Question Audio Section -->
        <div class="audio-section">
          <label class="audio-section-label">Audio për Pyetjen</label>

          <!-- Existing Question Audio -->
          <div *ngIf="existingQuestionAudio && !selectedQuestionAudio" class="existing-audio">
            <div class="audio-player">
              <audio controls>
                <source [src]="existingQuestionAudio.url" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>
            </div>
            <div class="audio-actions">
              <button type="button" mat-icon-button color="warn" (click)="removeQuestionAudio()" matTooltip="Hiq Audio">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>

          <!-- New Question Audio Upload -->
          <div *ngIf="!existingQuestionAudio || selectedQuestionAudio" class="file-upload-section">
            <label class="file-upload-label">Audio për Pyetjen (Opsionale)</label>
            <div class="file-upload-area">
              <input type="file"
                     #questionAudioInput
                     accept="audio/*"
                     (change)="onQuestionAudioSelected($event)"
                     class="file-input">
              <div class="upload-placeholder">
                <mat-icon>cloud_upload</mat-icon>
                <span>Klikoni për të zgjedhur një file audio</span>
                <small>MP3, WAV, ose formate të tjera audio</small>
              </div>
            </div>
            <div class="file-info" *ngIf="selectedQuestionAudio">
              <mat-icon>audiotrack</mat-icon>
              <span>{{ selectedQuestionAudio.name }}</span>
              <button type="button" mat-icon-button color="warn" (click)="selectedQuestionAudio = null" matTooltip="Hiq file">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
        </div>

        <div formArrayName="options" class="options-section">
          <p class="section-title-options">Opsionet e Përgjigjes</p>
          <div *ngFor="let option of options?.controls; let i = index" [formGroupName]="i" class="option-item">
            <p class="option-label">Opsioni {{ i + 1 }}</p>
            <div class="option-input-group">
              <mat-form-field appearance="outline" class="flex-grow">
                <mat-label>Teksti i Opsionit</mat-label>
                <textarea matInput formControlName="optionText" rows="3"></textarea>
                <mat-error *ngIf="option.get('optionText')?.hasError('required')">
                  Ky fushë nuk mund të jetë bosh.
                </mat-error>
              </mat-form-field>
              <mat-checkbox formControlName="isCorrect" class="option-checkbox">E Saktë</mat-checkbox>
            </div>

            <!-- Option Image Upload (only for image quiz types) -->
            <div class="file-upload-section" *ngIf="shouldShowImageFields()">
              <label class="file-upload-label">
                Imazh për Opsionin {{ i + 1 }} 
                <span *ngIf="areImagesRequired()" class="required-field">*</span>
                <mat-icon *ngIf="isOptionMissingImage(i)" 
                         class="warning-icon" 
                         matTooltip="Imazhi është i detyrueshëm për këtë opsion">warning</mat-icon>
              </label>

              <!-- Existing Option Image -->
              <div *ngIf="existingOptionImages[i] && !selectedOptionImages[i]" class="existing-image">
                <div class="image-preview">
                  <img [src]="existingOptionImages[i]?.url" 
                       [alt]="'Option ' + (i + 1) + ' image'" 
                       class="option-image clickable"
                       (click)="previewOptionImage(i)"
                       matTooltip="Klikoni për të parë më të madh">
                </div>
                <div class="image-actions">
                  <button type="button" mat-icon-button color="warn" (click)="removeOptionImage(i)" matTooltip="Hiq Imazh">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>

              <!-- New Option Image Upload -->
              <div *ngIf="!existingOptionImages[i] || selectedOptionImages[i]">
                <div class="file-upload-area">
                  <input type="file"
                         accept="image/*"
                         (change)="onOptionImageSelected($event, i)"
                         class="file-input">
                  <div class="upload-placeholder">
                    <mat-icon>image</mat-icon>
                    <span>Klikoni për të zgjedhur një imazh</span>
                    <small>JPG, PNG, GIF ose formate të tjera imazhi</small>
                  </div>
                </div>
                <div class="file-info" *ngIf="selectedOptionImages[i]">
                  <mat-icon>image</mat-icon>
                  <span>{{ selectedOptionImages[i]?.name }}</span>
                  <button type="button" mat-icon-button color="warn" (click)="selectedOptionImages[i] = null" matTooltip="Hiq file">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <mat-error *ngIf="quizFormGroup.get('options')?.hasError('oneCorrectOption')" class="options-error">
            Duhet të zgjidhni saktësisht një opsion të saktë.
          </mat-error>
          <mat-error *ngIf="areImagesRequired() && !validateImageOptions()" class="options-error">
            {{ getImageValidationError() }}
          </mat-error>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Shpjegimi i Përgjigjes (Opsionale)</mat-label>
          <textarea matInput formControlName="explanation" rows="10"></textarea>
          <mat-error *ngIf="quizFormGroup.get('explanation')?.hasError('required')">
            Shpjegimi është i detyrueshëm.
          </mat-error>
        </mat-form-field>

        <!-- Explanation Audio Section -->
        <div class="audio-section">
          <label class="audio-section-label">Audio për Shpjegimin</label>

          <!-- Existing Explanation Audio -->
          <div *ngIf="existingExplanationAudio && !selectedExplanationAudio" class="existing-audio">
            <div class="audio-player">
              <audio controls>
                <source [src]="existingExplanationAudio.url" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>
            </div>
            <div class="audio-actions">
              <button type="button" mat-icon-button color="warn" (click)="removeExplanationAudio()"
                      matTooltip="Hiq Audio">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>

          <!-- New Explanation Audio Upload -->
          <div *ngIf="!existingExplanationAudio || selectedExplanationAudio" class="file-upload-section">
            <label class="file-upload-label">Audio për Shpjegimin (Opsionale)</label>
            <div class="file-upload-area">
              <input type="file"
                     #explanationAudioInput
                     accept="audio/*"
                     (change)="onExplanationAudioSelected($event)"
                     class="file-input">
              <div class="upload-placeholder">
                <mat-icon>cloud_upload</mat-icon>
                <span>Klikoni për të zgjedhur një file audio</span>
                <small>MP3, WAV, ose formate të tjera audio</small>
              </div>
            </div>
            <div class="file-info" *ngIf="selectedExplanationAudio">
              <mat-icon>audiotrack</mat-icon>
              <span>{{ selectedExplanationAudio.name }}</span>
              <button type="button" mat-icon-button color="warn" (click)="selectedExplanationAudio = null" matTooltip="Hiq file">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
        </div>

        <div class="points-section">
          <div class="points-header">
            <mat-label>Pikët e Pyetjes</mat-label>
            <div class="points-display">
              <span class="points-value">{{ quizFormGroup.get('points')?.value }}</span>
              <span class="points-label">pikë</span>
            </div>
          </div>
          <mat-slider max="10" min="1" step="1" discrete="true" [showTickMarks]="true">
            <input matSliderThumb formControlName="points">
          </mat-slider>
          <div class="points-scale">
            <span>1</span>
            <span>5</span>
            <span>10</span>
          </div>
        </div>


        <div class="form-actions">
          <button mat-flat-button color="primary" [disabled]="!isFormValid()"
                  (click)="handleButtonClick()">
            {{ isEditMode ? 'Ruaj Ndryshimet' : 'Shto Pyetje' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Child Quizzes Section -->
  <div *ngIf="showChildQuizzesSection" class="child-quizzes-section">
    <div class="section-title">
      <h2>Nën-kuiz</h2>
      <p>Menaxhoni seksionet e ketyre nën-kuizeve.</p>
    </div>

    <div class="child-quizzes-header">
      <button mat-raised-button color="primary"
              [disabled]="!canAddChildQuizzes()"
              (click)="openAddChildQuizModal()"
              matTooltip="Shto kuiz të vegjël"
              class="add-child-quiz-button">
        <mat-icon>add</mat-icon>
        Shto Nën-kuiz
      </button>

      <div *ngIf="!canAddChildQuizzes()" class="warning-message">
        <mat-icon>warning</mat-icon>
        <span>{{ getChildQuizzesDisabledReason() }}</span>
      </div>
    </div>

    <div class="child-quizzes-list" *ngIf="childQuizzes.length > 0">
      <div *ngFor="let childQuiz of childQuizzes; let i = index" class="child-quiz-item">
        <div class="child-quiz-info">
          <div class="quiz-number">{{ i + 1 }}.</div>
          <div class="quiz-details">
            <h4>{{ childQuiz.question }}</h4>
            <p class="quiz-type">Lloji: {{ getQuizTypeName(childQuiz.quizType) }}</p>
            <p class="quiz-points">Pikët: {{ childQuiz.points }}</p>
          </div>
        </div>
        <div class="child-quiz-actions">
          <button mat-icon-button color="primary"
                  (click)="editChildQuiz(childQuiz)"
                  matTooltip="Modifiko kuizin e vegjël">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="warn"
                  (click)="deleteChildQuiz(childQuiz)"
                  matTooltip="Fshi kuizin e vegjël">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="childQuizzes.length === 0 && canAddChildQuizzes()" class="no-child-quizzes">
      <mat-icon>quiz</mat-icon>
      <p>Nuk ka nën-kuize të shtuar ende.</p>
      <p>Klikoni butonin "Shto" për të filluar.</p>
    </div>
  </div>

  <!-- Image Preview Modal -->
  <div *ngIf="showImagePreview" class="image-preview-modal" (click)="closeImagePreview()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ previewImageTitle }}</h3>
        <button mat-icon-button (click)="closeImagePreview()" class="close-button">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="modal-body">
        <img [src]="previewImageUrl" [alt]="previewImageTitle" class="preview-image">
      </div>
    </div>
  </div>
</div>
